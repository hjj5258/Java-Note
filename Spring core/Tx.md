### 事务

- 特性（ACID)
  - 原子性
  - 一致性
  - 隔离性
  - 持久性
  
- timeout（超时时间）事务在一定时间内进行提交，如果不提交则回滚，单位秒

- readonly（是否只读）true 只能查询

- rollbackFor（指定异常回滚）

- noRollbackFor（指定哪些异常不进行回滚）

- 传播方式（propagation）多个事务之间

  | 方式          | 说明                                                         |
  | ------------- | ------------------------------------------------------------ |
  | REQUIRED      | 如果当前没有事务，则新建一个事务;如果已经存在一个事务，则加入到这个事务中。这是最常见的选择 |
  | SUPPORTS      | 支持当前事务。如果当前没有事务，则以非事务方式执行           |
  | MANDATORY     | 使用当前的事务。如果当前没有事务，则抛出异常                 |
  | REQUIRES_NEW  | 新建事务。如果当前存在事务，则把当前事务挂起                 |
  | NOT_SUPPORTED | 以非事务方式执行操作。如果当前存在事务，则把当前事务挂起     |
  | NEVER         | 以非事务方式执行。如果当前存在事务，则抛出异常               |
  | NESTED        | 如果当前存在事务，则在嵌套事务内执行;如果当前没有事务，则执行与PROPAGATION_REQUIRED类似的操作 |

- 隔离级别（Isolation）事务数据问题

  - 脏读 事务可以读取未提交的数据
    - 如果有两个事务同时修改，A事务修改了之后 B事务是可见的，A未提交事务，导致B事务数据产生不一致
  - 不可重复读 直到事务提交前所做的任何操作其他事务都不可见
    - A事务读取后，B修改数据并提交事务，A读取到的数据会产生不一致，两次同样的查询，可能会有不一样的结果
  - 幻读 某个事务在读取范围内的数据时，另一个事务又在该范围内插入了新的记录，当当前事务再次读取该范围记录时，产生幻行
    - A事务对范围数据进行了修改，但B事务在该范围内进行了插入比A先提交了事务，导致A事务看起来有些数据没有生效

  | 级别                         | 脏读可能性 | 不可重复读可能性 | 幻读可能性 |
  | ---------------------------- | ---------- | ---------------- | ---------- |
  | READ_UNCOMMITTED（未读提交） | Yes        | Yes              | Yes        |
  | READ_COMMITTED（读提交）     | No         | Yes              | Yes        |
  | REPEATABLE_READ（可重复读）  | No         | No               | Yes        |
  | SERIALIZABLE（可串行化）     | No         | No               | No         |

  SERIALIZABLE在每一行上都加了锁，避免了幻读问题，但因此可能会导致大量的超时和锁争用的问题，性能很差

  MySQL默认可重复读，InnoDB 通过MVCC解决幻读的问题

  MVCC实现：通过保存数据在某个时间的点的快照来实现的，不管执行时间多长，每个事务看到的数据都是一致的，InnoDB通过行记录后面保存的两个隐藏列（行的创建时间，保存行的过期时间）不是实际时间值，是系统版本号，每开始一个事务就会自动递增，事务开始会把系统版本号作为事务的版本号，用来和查询到的版本号进行对比，例如version字段原理是类似的
  
  

